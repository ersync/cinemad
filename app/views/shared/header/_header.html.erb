<div class="fixed w-full z-50 antialiased">
  <%= render 'shared/header/desktop_header' %>
  <%= render 'shared/header/mobile_header' %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuButton = document.getElementById('menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const profileMenu = document.getElementById('mobile-profile-menu');
    const profileMenuOverlay = document.getElementById('profile-menu-overlay');
    const menuItems = document.querySelectorAll('.menu-item');
    const profileButton = document.querySelector('button[onclick="toggleProfileMenu(event)"]');

    function updateMenuIcon() {
      if (!menuButton || !mobileMenu) return;

      const isMenuOpen = !mobileMenu.classList.contains('-translate-x-full');

      if (isMenuOpen) {
        menuButton.classList.add('open');
      } else {
        menuButton.classList.remove('open');
      }
    }

    function toggleMenu() {
      if (!mobileMenu || !mobileMenuOverlay) return;

      mobileMenu.classList.toggle('-translate-x-full');

      if (mobileMenu.classList.contains('-translate-x-full')) {
        mobileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
      } else {
        mobileMenuOverlay.classList.remove('opacity-0', 'pointer-events-none');
      }

      updateMenuIcon();
    }

    function closeMenu() {
      if (!mobileMenu || !mobileMenuOverlay) return;

      mobileMenu.classList.add('-translate-x-full');
      mobileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
      updateMenuIcon();
    }

    function toggleProfileMenu(event) {
      if (event) {
        event.stopPropagation();
      }

      if (!profileMenu || !profileMenuOverlay) return;

      const isMenuOpen = !profileMenu.classList.contains('translate-y-full');

      if (isMenuOpen) {
        profileMenu.classList.add('translate-y-full');
        profileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
      } else {
        profileMenu.classList.remove('translate-y-full');
        profileMenuOverlay.classList.remove('opacity-0', 'pointer-events-none');
      }
    }

    function handleProfileMenuClick(event) {
      if (!profileMenu) return;

      if (profileButton && profileButton.contains(event.target)) {
        return;
      }

      const isClickInsideMenu = profileMenu.contains(event.target);
      const isMenuOpen = !profileMenu.classList.contains('translate-y-full');

      if (!isClickInsideMenu && isMenuOpen) {
        toggleProfileMenu();
      }
    }

    function initializeDropdowns() {
      menuItems.forEach(item => {
        const button = item.querySelector('button');
        const content = item.querySelector('div');
        const arrow = item.querySelector('svg');

        button?.addEventListener('click', () => {
          menuItems.forEach(otherItem => {
            if (otherItem !== item) {
              const otherContent = otherItem.querySelector('div');
              const otherArrow = otherItem.querySelector('svg');
              otherContent?.classList.add('hidden');
              otherArrow?.classList.remove('rotate-90');
            }
          });

          content?.classList.toggle('hidden');
          arrow?.classList.toggle('rotate-90');
        });
      });
    }

    function initializeSwipeHandler() {
      if (!mobileMenu) return;

      let touchStartX = 0;
      let touchEndX = 0;

      mobileMenu.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });

      mobileMenu.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        if (touchStartX - touchEndX > 50) {
          closeMenu();
        }
      });
    }

    function handleClickOutside(event) {
      if (!menuButton || !mobileMenu) return;

      const isClickInsideButton = menuButton.contains(event.target);
      const isClickInsideMenu = mobileMenu.contains(event.target);
      const isMenuOpen = !mobileMenu.classList.contains('-translate-x-full');

      if (!isClickInsideButton && !isClickInsideMenu && isMenuOpen) {
        closeMenu();
      }
    }

    menuButton?.addEventListener('click', toggleMenu);
    mobileMenuOverlay?.addEventListener('click', closeMenu);
    profileMenuOverlay?.addEventListener('click', (e) => toggleProfileMenu(e));
    document.addEventListener('click', handleClickOutside);
    document.addEventListener('click', handleProfileMenuClick);

    initializeDropdowns();
    initializeSwipeHandler();

    updateMenuIcon();

    function cleanup() {
      menuButton?.removeEventListener('click', toggleMenu);
      mobileMenuOverlay?.removeEventListener('click', closeMenu);
      profileMenuOverlay?.removeEventListener('click', toggleProfileMenu);
      document.removeEventListener('click', handleClickOutside);
      document.removeEventListener('click', handleProfileMenuClick);
    }

    window.toggleProfileMenu = toggleProfileMenu;
  });
</script>